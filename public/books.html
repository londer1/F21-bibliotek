<!DOCTYPE html>
<html lang="no">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bibliotek Utlånssystem</title>
        <link rel="stylesheet" href="/public/style.css">
        <script type="module">
            import { format } from 'date-fns';
        </script>
    </head>
    
<body>
    <h1>Bokliste</h1>
    <div id="book-list">Laster bøker...</div>

    <h2>Elever som låner bøker</h2>
    <div id="loan-list">Laster låneoversikt...</div>

    <h2>Opprett nytt utlån</h2>
    <div>
        <input type="text" id="search-student" placeholder="Søk etter elev..." />
        <div id="student-list">Ingen elever funnet.</div>

        <label for="return-date">Leveringsdato:</label>
        <input type="date" id="return-date" required />
    </div>

    <button id="back-to-home">Tilbake til Hjem</button>

    <script>
        window.onload = () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            } else {
                loadBooks();
                loadLoans();
            }
        };

        function loadBooks() {
            const token = localStorage.getItem('token');
            fetch('http://localhost:3000/books', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(books => {
                const bookListDiv = document.getElementById('book-list');
                bookListDiv.innerHTML = books.map(book => `
                    <div>
                        Tittel: ${book.Tittel}, Forfatter: ${book.Forfatter} 
                        <button onclick="createLoan(${book.BokID})">Lån</button>
                    </div>
                `).join('');
            });
        }

        function loadLoans() {
    const token = localStorage.getItem('token');
    fetch('http://localhost:3000/loans', {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(loans => {
        console.log(loans); // Legg til denne linjen for å sjekke dataene
        const loanListDiv = document.getElementById('loan-list');
        if (loans.length > 0) {
            loanListDiv.innerHTML = loans.map(loan => {
                const formattedUtlånsdato = new Date(loan.Utlånsdato).toLocaleDateString('no-NO');
                let formattedReturDato = 'Ikke satt';
                
                if (loan.Returdato) {
                    const returdato = new Date(loan.Returdato);
                    if (!isNaN(returdato)) {
                        formattedReturdato = returdato.toLocaleDateString('no-NO');
                    }
                }

                return `
                    <div>
                        Elev: ${loan.ElevNavn}, Bok: ${loan.BokTittel}, 
                        Utlånsdato: ${formattedUtlånsdato}, 
                        Returdato: ${formattedReturdato}
                        <button onclick="handleReturn(${loan.UtlånsID})">Marker som innlevert</button>
                    </div>
                `;
            }).join('');
        } else {
            loanListDiv.innerText = 'Ingen elever låner noen bøker for øyeblikket.';
        }
    });
}



        function searchStudents() {
            const token = localStorage.getItem('token');
            const query = document.getElementById('search-student').value;
            fetch(`http://localhost:3000/students?search=${query}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(students => {
                const studentListDiv = document.getElementById('student-list');
                studentListDiv.innerHTML = students.map(student => `
                    <div>${student.ElevNavn} (ElevID: ${student.ElevID}) 
                    <button onclick="confirmLoan(${student.ElevID})">Velg</button></div>
                `).join('');
            });
        }

        function createLoan(bookId) {
            const selectedStudentId = prompt('Skriv inn ElevID for utlån:');
            const returnDate = document.getElementById('return-date').value;
            if (!selectedStudentId || !returnDate) {
                alert('Vennligst fyll ut ElevID og Leveringsdato!');
                return;
            }

            const token = localStorage.getItem('token');
            fetch('http://localhost:3000/loans', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ BokID: bookId, ElevID: selectedStudentId, ReturDato: returnDate })
            })
            .then(res => res.json())
            .then(response => {
                alert(response.message);
                loadLoans();
            });
        }

        function handleReturn(utlånsID) {
            const token = localStorage.getItem('token');
            fetch('http://localhost:3000/loans/return', {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ UtlånsID: utlånsID })
            }).then(response => {
                if (response.ok) {
                    alert('Bok markert som innlevert');
                    loadLoans();
                }
            });
        }

        document.getElementById('search-student').addEventListener('input', searchStudents);

        document.getElementById('back-to-home').addEventListener('click', function() {
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
